

---
layout: page
title: Taller de PostGIS y CartoCSS con CartoDB
category: intermediate
date: 2016-06-18
author: 'Ramiro Aznar, Oriol Boix'
length: 3h
---

* Trainers:
  * Ramiro Aznar · ramiroaznar@cartodb.com · [@ramiroaznar](http://twitter.com/ramiroaznar)
  * Oriol Boix · oboix@cartodb.com · [@oriolbx](http://twitter.com/oriolbx)
* Collaborators:
  * Ernesto Martínez · ernesto@cartodb.com · [@ernesmb](http://twitter.com/ernesmb)
  * Jorge Sanz · jorge@cartodb.com · [@xurxosanz](http://twitter.com/xurxosanz)
* June 18th 2016
* Taller de PostGIS y CartoCSS con CartoDB


#### Further questions and troubleshooting

* **[GIS Stack Exchange](http://gis.stackexchange.com/questions/tagged/cartodb)** `cartodb` tag
* email to **support@cartodb.com**

## Contents
- [Importing datasets](#import)
- [Getting your data ready](#dataset)
- [Going spatial with PostGIS](#postgis)


----



### 1. Datasets

These are the datasets we are going to use on our workshop. You'll find them
all on our [Data Library](https://cartodb.com/data-library) and fit way well
on a free account.

* **Populated Places** [`ne_10m_populated_places_simple`]: City and town points.
* **World Borders** [`world_borders`]: World countries borders.
* **Land** [`ne_50m_land`]: World emerged lands.
* **European countries** [`ne_adm0_europe`]: European countries geometries.

## 2. Going spatial with PostGIS <a name="postgis"></a>

### 2.1 Working with projections

#### `geometry` vs. `geography`
* **`Geometry`** uses a cartesian plane to measure and store features (CRS units):

    >The basis for the PostGIS `geometry` type is a plane. The shortest path between two points on the plane is a straight line. That means calculations on geometries (areas, distances, lengths, intersections, etc) can be calculated using cartesian mathematics and straight line vectors.

* **`Geography`** uses a sphere to measure and store features (Meters):

    >The basis for the PostGIS `geography` type is a sphere. The shortest path between two points on the sphere is a great circle arc. That means that calculations on geographies (areas, distances, lengths, intersections, etc) must be calculated on the sphere, using more complicated mathematics. For more accurate measurements, the calculations must take the actual spheroidal shape of the world into account, and the mathematics becomes very complicated indeed.

More about the `geography` type can be found [here](http://workshops.boundlessgeo.com/postgis-intro/geography.html) and [here](http://postgis.net/docs/manual-1.5/ch04.html#PostGIS_Geography).

![cart vs sph](../img/common/cartesian_spherical.jpg)

![LA-CDG](../img/common/lax_cdg.jpg)

_Source: [Boundless Postgis intro](http://workshops.boundlessgeo.com/postgis-intro)_

#### `the_geom` vs. `the_geom_webmercator`
* **`the_geom`** EPSG:4326. Unprojected coordinates in **decimal degrees** (Lon/Lat). WGS84 Spheroid.
* **`the_geom_webmercator`** EPSG:3857. UTM projected coordinates in **mercator units**. This is a conventional Coordinate Reference System, widely accepted as a 'de facto' standard in webmapping.

In CartoDB, **the_geom_webmercator column is the one we see represented in the map**. Know more about projections:

* In [this tutorial](http://docs.cartodb.com/tutorials/projections/).
* [Map Projections in Wikipedia](https://en.wikipedia.org/wiki/Map_projection).
* In [this CartoDB blog post](http://blog.cartodb.com/free-your-maps-web-mercator/).

### 2.2 Changing map projections

#### Accessing the **list of default projections** available in CartoDB:

```sql
SELECT
  *
FROM
  spatial_ref_sys
```

![srid](../img/common/srid.png)

#### Accessing the hidden **the_geom_webmercator** field:

```sql
SELECT
  the_geom_webmercator
FROM
  ne_50m_land
```

#### Adding **World Robinson** projection (ESPG:54030):

```sql
INSERT INTO spatial_ref_sys
  (srid, auth_name, auth_srid, proj4text, srtext) values (54030, 'EPSG', 54030,
'+proj=robin +datum=WGS84','PROJCS["World_Robinson",
    GEOGCS["GCS_WGS_1984",
        DATUM["WGS_1984",
            SPHEROID["WGS_1984",6378137,298.257223563]],
        PRIMEM["Greenwich",0],
        UNIT["Degree",0.017453292519943295]],
    PROJECTION["Robinson"],
    PARAMETER["False_Easting",0],
    PARAMETER["False_Northing",0],
    PARAMETER["Central_Meridian",0],
    UNIT["Meter",1],
    AUTHORITY["EPSG","54030"]]');
```

#### ST_Transform()

```sql
SELECT
  cartodb_id, ST_Transform(the_geom, 54030) AS the_geom_webmercator
FROM
  ne_50m_land
```

![robinson](../img/common/robinson.png)

_About [`ST_Transform`](http://postgis.net/docs/ST_Transform.html)._


### 2.3 Geometric relations

* Equals: [ST_Equals](http://postgis.net/docs/ST_Equals.html)
* Disjoint: [ST_Disjoint](http://postgis.net/docs/ST_Disjoint.html)
* Intersects: [ST_Intersects](http://postgis.org/docs/ST_Intersects.html)
* Touches: [ST_Touches](http://postgis.net/docs/ST_Touches.html)
* Crosses: [ST_Crosses](http://postgis.net/docs/ST_Crosses.html)
* Within: [ST_Within](http://postgis.net/docs/manual-1.4/ST_Within.html)
* Contains: [ST_Contains](http://postgis.net/docs/manual-1.4/ST_Contains.html)
* Overlaps: [ST_Overlaps](http://postgis.net/docs/manual-1.4/ST_Overlaps.html)

Examlples:

![spatialrelations](../img/common/TopologicSpatialRelations2.png)

_Source: [Wikipedia examples of spatial relations](https://en.wikipedia.org/wiki/DE-9IM)_

\***Important**: The geometric relations are very strict, make sure that the geometries that you will use are valid.
Use the valid functions of PostGIS to check if the geometries are valid or not.


_About [`ST_isValid`](http://postgis.net/docs/ST_IsValid.html),[`ST_MakeValid`](http://postgis.net/docs/ST_MakeValid.html),[`ST_isValidReason`](http://postgis.net/docs/ST_IsValidReason.html),[`ST_IsValidDetail`](http://postgis.net/docs/ST_IsValidDetail.html)._


#### Get the number of points inside a polygon

Using `GROUP BY`:

```sql
SELECT
  e.cartodb_id,
  e.admin,
  e.the_geom_webmercator,
  count(*) AS pp_count,
  sum(p.pop_max) as sum_pop
FROM
  ne_adm0_europe e
JOIN
  ne_10m_populated_places_simple p
ON
  ST_Intersects(p.the_geom, e.the_geom)
GROUP BY
  e.cartodb_id
```

Using `LATERAL`:

```sql
SELECT
  a.cartodb_id,
  a.admin AS name,
  a.the_geom_webmercator,
  counts.number_cities,
  to_char(counts.sum_pop,'999,999,999') as sum_pop --decimal separator
FROM
  ne_adm0_europe a
CROSS JOIN LATERAL
  (
    SELECT
      count(*) as number_cities,
      sum(pop_max) as sum_pop
    FROM
      ne_10m_populated_places_simple b
    WHERE
      ST_Intersects(a.the_geom, b.the_geom)
  ) AS counts
```
_About [Lateral JOIN](http://blog.heapanalytics.com/postgresqls-powerful-new-join-type-lateral)_

![ADD IMAGE](../img/common/intersects.png)



### 2.4 Proximity analysis


#### ST_Distance

```sql
SELECT b.name, st_distance(a.the_geom_webmercator,b.the_geom_webmercator) as distancia
FROM
  populated_places a,
  populated_places b
WHERE
ST_distance(a.the_geom_webmercator,b.the_geom_webmercator) < 300000
  AND a.name = 'Madrid'
  AND a.cartodb_id != b.cartodb_id
ORDER BY st_distance(a.the_geom_webmercator,b.the_geom_webmercator)
```
Execution time: 8.344 ms

_About [`ST_Distance`](http://postgis.refractions.net/docs/ST_Distance.html)._



#### ST_Expand + ST_Distance

```sql
SELECT b.name,st_distance(a.the_geom_webmercator,b.the_geom_webmercator) as distancia
FROM
  populated_places a,
  populated_places b
WHERE
ST_Expand(a.the_geom_webmercator,300000) && b.the_geom_webmercator
AND
ST_distance(a.the_geom_webmercator,b.the_geom_webmercator) < 300000
  AND a.name = 'Madrid'
  AND a.cartodb_id != b.cartodb_id
ORDER BY st_distance(a.the_geom_webmercator,b.the_geom_webmercator)
```

Execution time: 3.452 ms

_About [`ST_Expand`](http://postgis.net/docs/ST_Expand.html)._

#### ST_DWithin

```sql
SELECT b.name,st_distance(a.the_geom_webmercator,b.the_geom_webmercator) as distancia
FROM
  populated_places a,
  populated_places b
WHERE
ST_DWithin(a.the_geom_webmercator,b.the_geom_webmercator,300000)
  AND a.name = 'Madrid'
  AND a.cartodb_id != b.cartodb_id
ORDER BY st_distance(a.the_geom_webmercator,b.the_geom_webmercator)
```
Execution time: 2.006 ms


_About [`ST_DWithin`](http://postgis.net/docs/ST_DWithin.html)._


### 2.5 Geoprocessing

#### Create a **buffer** from points:

```sql
SELECT
  cartodb_id,
  name,
  ST_Transform(
    ST_Buffer(the_geom::geography, 50000)::geometry
    ,3857
  ) AS the_geom_webmercator
FROM
  populated_places
WHERE
  name ilike 'madrid'
```

![buffer](../img/common/buffer.png)

_About [`ST_Buffer`](http://postgis.net/docs/ST_Buffer.html)._

---
**Note**: try to compute a Buffer on a place with high latitude and check the difference between using directly `the_geomwebmecator` and `the_geom::geography`
---

#### Get the **difference** between two geometries:

```sql
SELECT
  a.cartodb_id,
    ST_Difference(
        a.the_geom_webmercator,
        b.the_geom_webmercator
  ) AS the_geom_webmercator
FROM
  ne_50m_land a,
  ne_adm0_europe b
WHERE
  b.adm0_a3 like 'ESP'
```

![difference](../img/common/difference.png)

_About [`ST_Difference`](http://postgis.net/docs/ST_Difference.html)._

#### Create a **straight line** between two points:

```sql
SELECT
  ST_MakeLine(a.the_geom_webmercator,b.the_geom_webmercator) as the_geom_webmercator
FROM (SELECT * FROM populated_places
    WHERE name ILIKE 'madrid') as a,
    (SELECT * FROM populated_places
    WHERE name ILIKE 'barcelona'AND adm0name ILIKE 'spain') as b
```

![lines](../img/common/lines.png)

_About [`ST_MakeLine`](http://postgis.net/docs/ST_MakeLine.html)._

#### Create **great circles** between two points:

```sql
SELECT
  ST_Transform(
  ST_Segmentize(
      ST_Makeline(
        a.the_geom,
        b.the_geom
      )::geography,
      100000
  )::geometry,
  3857
  ) as the_geom_webmercator
FROM
  (SELECT * FROM populated_places
  WHERE name ILIKE 'madrid') as a,
  (SELECT * FROM populated_places
  WHERE name ILIKE 'new york') as b
```

![greatcircles](../img/common/greatcircles.png)

_About [Great Circles](http://blog.cartodb.com/jets-and-datelines/)._

#### Generating Grids with CDB functions

**Rectangular grid**

```sql
SELECT
  row_number() over () as cartodb_id,
  CDB_RectangleGrid(
    ST_Buffer(the_geom_webmercator,125000),
  250000,
  250000
  ) AS the_geom_webmercator
FROM
  ne_adm0_europe
WHERE
  adm0_a3 IN ('ITA','GBR')
```

![ADD IMAGE](../img/common/rect_grid.png)

_About [CDB_RectangleGrid](http://docs.cartodb.com/tips-and-tricks/cartodb-functions/#a-rectangle-grid)_

**Adaptative Hexagonal grid**

```sql
WITH grid AS
(SELECT
  row_number() over () as cartodb_id,
  CDB_HexagonGrid(
    ST_Buffer(the_geom_webmercator, 100000),
    100000
  ) AS the_geom_webmercator
FROM
  ne_adm0_europe
WHERE
  adm0_a3 IN ('ESP','ITA'))

SELECT
  grid.the_geom_webmercator,
  grid.cartodb_id
FROM
  grid, ne_adm0_europe a
WHERE
    ST_intersects(grid.the_geom_webmercator, a.the_geom_webmercator)
  AND a.adm0_a3 IN ('ESP','ITA')
```

![ADD IMAGE](../img/common/hex_grid.png)

_About [CDB_HexagonGrid](http://docs.cartodb.com/tips-and-tricks/cartodb-functions/#a-hexagon-grid)_

----

